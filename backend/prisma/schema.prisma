generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum NotificationType {
  REPLY_ON_THREAD
  LIKE_ON_THREAD
}

model User {
  id                String   @id @default(uuid())
  clerkUserId     String @unique

  displayName      String?
  handle            String @unique
  avatarUrl        String?
  bio               String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

   threads      Thread[]
   replies       Reply[]        @relation("UserReplies")
  threadReacts  ThreadReaction[] @relation("UserReactions")

   notifications      Notification[] @relation("UserNotifications")
  actedNotifications Notification[] @relation("ActorNotifications")
  sentMessages       DirectMessage[] @relation("SentMessages")
  receivedMessages  DirectMessage[] @relation("ReceivedMessages")

  @@map("users")
}

model Category {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?

  threads     Thread[]

  @@map("categories")
}

model Thread {
  id            String   @id @default(uuid())

  categoryId    String
  authorUserId  String

  title         String
  body          String

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category      Category @relation(fields: [categoryId], references: [id])
  author        User     @relation(fields: [authorUserId], references: [id])
  replies       Reply[]  @relation("ThreadReplies")
  reactions     ThreadReaction[] @relation("ThreadReactions")

 notifications Notification[]

  @@index([categoryId, createdAt(sort: Desc)])
  @@map("threads")
}

model Reply {
  id            String   @id @default(uuid())
  threadId      String
  authorUserId  String
  body          String
  createdAt     DateTime @default(now())

  thread        Thread   @relation("ThreadReplies", fields: [threadId], references: [id])
  author        User     @relation("UserReplies", fields: [authorUserId], references: [id])

  @@map("replies")
}

model ThreadReaction {
  threadId  String
  userId    String

 thread    Thread @relation("ThreadReactions", fields: [threadId], references: [id])
  user      User   @relation("UserReactions", fields: [userId], references: [id])

  @@id([threadId, userId])
  @@map("thread_reactions")
}

model Notification {
  id            String           @id @default(uuid())
  
  userId        String
  actorUserId   String
  threadId      String

  type          NotificationType

  createdAt     DateTime         @default(now())
  readAt        DateTime?

 
  user          User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)
  actor         User             @relation("ActorNotifications", fields: [actorUserId], references: [id], onDelete: Cascade)
  thread        Thread           @relation(fields: [threadId], references: [id], onDelete: Cascade)

  @@index([userId, readAt], name: "idx_notifications_user_read")
   @@map("notification")
}

model DirectMessage {
  id               String   @id @default(uuid())

  senderUserId     String
  recipientUserId String

  body             String?
  imageUrl         String?

  createdAt        DateTime @default(now())

  sender           User     @relation("SentMessages", fields: [senderUserId], references: [id], onDelete: Cascade)
  recipient        User     @relation("ReceivedMessages", fields: [recipientUserId], references: [id], onDelete: Cascade)

  @@index([senderUserId, recipientUserId, createdAt(sort: Desc)], name: "idx_dm_sender_recipient_created_at")
   @@map("directmessage")
}
